require('dotenv').config();
const { Client, GatewayIntentBits, Collection, EmbedBuilder } = require('discord.js');
const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.DirectMessages,
    GatewayIntentBits.GuildMembers
  ],
  partials: ['CHANNEL']
});

// Load slash commands
client.commands = new Collection();
const commandFiles = fs.readdirSync('./commands').filter(file => file.endsWith('.js'));
for (const file of commandFiles) {
  const command = require(`./commands/${file}`);
  client.commands.set(command.data.name, command);
}

// Bot ready
client.once('ready', async () => {
  console.log(`âœ… Bloom Haven Bot is online as ${client.user.tag}`);
  const { REST, Routes } = require('discord.js');
  const rest = new REST({ version: '10' }).setToken(process.env.DISCORD_TOKEN);
  const commands = commandFiles.map(file => require(`./commands/${file}`).data.toJSON());
  await rest.put(Routes.applicationCommands(client.user.id), { body: commands });
  console.log('âœ… Slash commands registered.');
});

// Slash command handler
client.on('interactionCreate', async interaction => {
  if (interaction.isChatInputCommand()) {
    const command = client.commands.get(interaction.commandName);
    if (!command) return;
    try {
      await command.execute(interaction, client);
    } catch (err) {
      console.error(err);
      await interaction.reply({ content: 'âŒ Error executing command.', ephemeral: true });
    }
  }
});

// DM logging
client.on('messageCreate', async message => {
  if (message.author.bot || message.guild) return;
  const logChannel = await client.channels.fetch('1399416161631993866').catch(() => null);
  if (!logChannel) return;
  await logChannel.send({
    content: `ğŸ“¨ **DM from ${message.author.tag}** (\`${message.author.id}\`)\n> ${message.content || '[No text]'}`,
    files: message.attachments.map(a => a.url)
  });
});

// Express server
const app = express();
const PORT = process.env.PORT || 8080;
app.use(bodyParser.json());

app.get('/', (_, res) => res.send('ğŸŒ¸ Bloom Haven Bot is online!'));

// Webhook
app.post('/shopify-webhook', async (req, res) => {
  const order = req.body;
  const discordId = order?.customer?.last_name?.trim();
  const robloxUser = order?.customer?.first_name?.trim();
  const orderId = order?.order_number || '?';
  const total = order?.total_price || '?';
  const paymentMethod = order?.payment_gateway_names?.[0] || 'Not Found';
  const items = order?.line_items?.map(i => `${i.name} x${i.quantity}`).join('\n') || 'No items';
  const landingSite = order?.landing_site || '';

  const isArabic = landingSite.includes('/ar');

  if (!discordId || !robloxUser) {
    console.warn('âš ï¸ Missing Discord ID or Roblox username');
    return res.status(400).send('Missing buyer info');
  }

  const user = await client.users.fetch(discordId).catch(() => null);
  if (!user) {
    console.warn('âš ï¸ Cannot find Discord user');
    return res.status(404).send('Discord user not found');
  }

  // Message
  const message = isArabic
    ? `ğŸ¤– **ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§**

ğŸ§¾ **Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:** \`#${orderId}\`
ğŸ® **Ø§Ø³Ù… Ø±ÙˆØ¨Ù„ÙˆÙƒØ³:** \`${robloxUser}\`
ğŸ’³ **Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:** \`${paymentMethod}\`

âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆÙ‡Ùˆ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†.

ğŸ”— **Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹:** https://www.paypal.com/paypalme/oilmoney001

1ï¸âƒ£ Ø§Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø¯Ù‚Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡.  
2ï¸âƒ£ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨.  
3ï¸âƒ£ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.

ğŸ“¡ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.  
ğŸ“¦ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø³ÙŠØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ³Ù„ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©.

ğŸ’¬ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© **Bloom Haven AutoOrder v2.1**`
    : `ğŸ¤– **Order Confirmed Automatically**

ğŸ§¾ **Order ID:** \`#${orderId}\`
ğŸ® **Roblox Username:** \`${robloxUser}\`
ğŸ’³ **Selected Payment Method:** \`${paymentMethod}\`

âœ… Your order has been registered and is now pending payment.

ğŸ”— **Payment Link:** https://www.paypal.com/paypalme/oilmoney001

1ï¸âƒ£ Donate the exact amount of your items via the PayPal link above.  
2ï¸âƒ£ Ensure your name matches your order.  
3ï¸âƒ£ Payment will be auto-verified shortly.

ğŸ“¡ Our system will automatically verify your payment.  
ğŸ“¦ Once confirmed, your item will be queued for in-game delivery.

ğŸ’¬ This message was generated by **Bloom Haven AutoOrder v2.1**`;

  // Log Embed
  const embed = new EmbedBuilder()
    .setTitle(isArabic ? 'ğŸ“¦ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯' : 'ğŸ“¦ New Order Received')
    .setDescription(
      `**User:** <@${discordId}>\n` +
      `**Order ID:** #${orderId}\n` +
      `**Roblox:** ${robloxUser}\n` +
      `**Items:**\n${items}\n` +
      `**Total:** $${total}\n` +
      `**Lang:** ${isArabic ? 'ğŸ‡¸ğŸ‡¦ Arabic' : 'ğŸ‡ºğŸ‡¸ English'}`
    )
    .setColor(isArabic ? 0xf1c40f : 0x2ecc71)
    .setTimestamp();

  try {
    await user.send(message);
    const logChannel = await client.channels.fetch('1397212138753495062');
    await logChannel.send({ embeds: [embed] });
    await logChannel.send(`âœ… DM sent to <@${discordId}>`);
    return res.status(200).send('âœ… Message sent and order logged');
  } catch (err) {
    console.error('âŒ Failed to DM or log:', err);
    return res.status(500).send('âŒ DM or logging failed');
  }
});

app.listen(PORT, () => {
  console.log(`ğŸŒ Web server running on port ${PORT}`);
});

client.login(process.env.DISCORD_TOKEN);
